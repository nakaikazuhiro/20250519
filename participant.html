<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å‚åŠ è€…ç”»é¢</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#fafafa}
h2{margin:0 0 10px}
h3{margin:16px 0 6px}
button{padding:6px 14px;margin:4px;border:none;border-radius:4px;font-size:14px;cursor:pointer}
.primary{background:#1976d2;color:#fff}
td.click{cursor:pointer}
table{border-collapse:collapse;width:100%;font-size:12px;margin-bottom:12px}
th,td{border:1px solid #ccc;padding:4px;text-align:center}
.hidden{display:none}
</style>

<!-- â˜… GAS é€šä¿¡ãƒ˜ãƒ«ãƒ‘ãƒ¼ -->
<script>
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxFvnUFdjhqrsLWccf5LMXILSX6BiaLJopmX5WSqpqfAwGvJ8qQaWz_0XTak5cLP0XW/exec';         // â† ã“ã“ã‚’æ›¸ãæ›ãˆ

  async function apiPost(body){                 // POSTï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ãªã— = text/plainï¼‰
    const r = await fetch(ENDPOINT,{ method:'POST', body:JSON.stringify(body) });
    return r.json();
  }
  async function apiGet(query){                 // GET
    const r = await fetch(`${ENDPOINT}?${query}`);
    return r.json();
  }
</script>
</head>

<body>
<h2 id="title">ã”äºˆå®šã®å…¥åŠ›</h2>

 <!-- ã‚¤ãƒ™ãƒ³ãƒˆIDå…¥åŠ›ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒç„¡ã„ã¨ãï¼‰ -->
 <div id="selectorWrap">
  <label>ğŸ”„: <input type="text" id="eventInput"></label>
  <button id="loadBtn" class="primary">ğŸ”„å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚</button>
  </div>

<!-- å‚åŠ å…¥åŠ›UI -->
<div id="mainWrap" class="hidden"> <p id="info"></p>
  <div><label>ãŠåå‰ï¼š<input type="text" id="pName"></label></div>
  <div style="margin-top:8px;">
    <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰ï¼š<br>
      <textarea id="noteInput" rows="3" cols="40" placeholder="ãŠä¼ãˆã—ãŸã„ã“ã¨ãŒã‚ã‚Œã°ã”è¨˜å…¥ãã ã•ã„"></textarea>
    </label>
  </div>
  <div id="tblWrap" style="margin-top:10px"></div>
  <button id="submitBtn" class="primary">å›ç­”ã‚’é€ä¿¡</button>
</div>

<script>
/* ===== å…±é€š ===== */
const marks = ['ã€‡','â–³','Ã—'];
const qs    = new URLSearchParams(location.search);
let eventId = qs.get('event') || '';

/* ===== 1. ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€ ===== */
document.getElementById('loadBtn').onclick = async ()=>{
  eventId = document.getElementById('eventInput').value.trim();
  if(!eventId){ alert('å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚'); return; }
  await loadEvent();
};

async function loadEvent(){
  const ev = await apiGet('eventId='+eventId);
  if(ev.status==='not found'){ alert('ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“'); return; }

  /* ã‚¿ã‚¤ãƒˆãƒ«ãƒ»åŸºæœ¬æƒ…å ± */
  document.getElementById('title').textContent = `ã€Œ${ev.title}ã€ã¸ã®å‚åŠ å…¥åŠ›`;
  document.getElementById('info').textContent  = `ã‚¤ãƒ™ãƒ³ãƒˆID: ${eventId}`;
  document.getElementById('selectorWrap').classList.add('hidden');
  document.getElementById('mainWrap').classList.remove('hidden');

  buildTable(ev.dates||[]);
}

/* ===== 2. ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ ===== */
function buildTable(slots){
  const wrap = document.getElementById('tblWrap'); wrap.innerHTML='';
  if(slots.length===0){ wrap.textContent='å€™è£œæ—¥æ™‚ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'; return; }

  /* YYYY-MM-DD ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ– */
  const grouped={};
  slots.forEach(s=>{
    const [d]=s.split(' ');
    (grouped[d]??=[]).push(s);
  });

  Object.keys(grouped).sort().forEach(date=>{
    wrap.insertAdjacentHTML('beforeend', `<h3>${date}</h3>`);
    const tbl=document.createElement('table');
    tbl.innerHTML='<tr><th>æ™‚é–“</th><th>å¯å¦</th></tr>';
    grouped[date].forEach(slot=>{
      const tr=document.createElement('tr');
      tr.insertAdjacentHTML('beforeend', `<td>${slot.split(' ')[1]}</td>`);
      const td=document.createElement('td');
      td.className='click'; td.dataset.slot=slot; td.textContent='ã€‡';
      td.onclick=()=>{ td.textContent = marks[(marks.indexOf(td.textContent)+1)%marks.length]; };
      tr.appendChild(td); tbl.appendChild(tr);
    });
    wrap.appendChild(tbl);
  });
}

/* ===== 3. é€ä¿¡ ===== */
document.getElementById('submitBtn').onclick = async ()=>{
  const name = document.getElementById('pName').value.trim();
  if(!name){ alert('åå‰ã‚’å…¥åŠ›'); return; }

  const note = document.getElementById('noteInput').value.trim();
  const avail={};
  document.querySelectorAll('td.click').forEach(td=>{
    avail[td.dataset.slot]=td.textContent;
  });

  const res = await apiPost({
    mode   : 'answer',
    eventId: eventId,
    name   : name,
    choices: avail,
    note   : note
  });
  if(res.status==='success'){
    alert('é€ä¿¡ã—ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ç”»é¢ã‚’é–‰ã˜ã¦ã„ãŸã ã„ã¦å¤§ä¸ˆå¤«ã§ã™ã€‚');
    location.reload();
  }else alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
};

/* ===== 4. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã™ããƒ­ãƒ¼ãƒ‰ ===== */
if(eventId) loadEvent();
</script>
</body>
</html>
