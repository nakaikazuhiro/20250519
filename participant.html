<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>参加者画面</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#fafafa}
h2{margin:0 0 10px}
h3{margin:16px 0 6px}
button{padding:6px 14px;margin:4px;border:none;border-radius:4px;font-size:14px;cursor:pointer}
.primary{background:#1976d2;color:#fff}
td.click{cursor:pointer}
table{border-collapse:collapse;width:100%;font-size:12px;margin-bottom:12px}
th,td{border:1px solid #ccc;padding:4px;text-align:center}
.hidden{display:none}
</style>

<!-- ★ GAS 通信ヘルパー -->
<script>
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxFvnUFdjhqrsLWccf5LMXILSX6BiaLJopmX5WSqpqfAwGvJ8qQaWz_0XTak5cLP0XW/exec';         // ← ここを書き換え

  async function apiPost(body){                 // POST（ヘッダーなし = text/plain）
    const r = await fetch(ENDPOINT,{ method:'POST', body:JSON.stringify(body) });
    return r.json();
  }
  async function apiGet(query){                 // GET
    const r = await fetch(`${ENDPOINT}?${query}`);
    return r.json();
  }
</script>
</head>

<body>
<h2 id="title">ご予定の入力</h2>

 <!-- イベントID入力（パラメータが無いとき） -->
 <div id="selectorWrap">
  <label>イベントID（入力不要）: <input type="text" id="eventInput"></label>
  <button id="loadBtn" class="primary">少々お待ちください。</button>
  </div>

<!-- 参加入力UI -->
<div id="mainWrap" class="hidden"> <p id="info"></p>
  <div><label>お名前：<input type="text" id="pName"></label></div>
  <div style="margin-top:8px;">
    <label>備考（任意）：<br>
      <textarea id="noteInput" rows="3" cols="40" placeholder="お伝えしたいことがあればご記入ください"></textarea>
    </label>
  </div>
  <div id="tblWrap" style="margin-top:10px"></div>
  <button id="submitBtn" class="primary">回答を送信</button>
</div>

<script>
/* ===== 共通 ===== */
const marks = ['〇','△','×'];
const qs    = new URLSearchParams(location.search);
let eventId = qs.get('event') || '';

/* ===== 1. イベントを読み込む ===== */
document.getElementById('loadBtn').onclick = async ()=>{
  eventId = document.getElementById('eventInput').value.trim();
  if(!eventId){ alert('少々お待ちください。'); return; }
  await loadEvent();
};

async function loadEvent(){
  const ev = await apiGet('eventId='+eventId);
  if(ev.status==='not found'){ alert('イベントが存在しません'); return; }

  /* タイトル・基本情報 */
  document.getElementById('title').textContent = `「${ev.title}」への参加入力`;
  document.getElementById('info').textContent  = `イベントID: ${eventId}`;
  document.getElementById('selectorWrap').classList.add('hidden');
  document.getElementById('mainWrap').classList.remove('hidden');

  buildTable(ev.dates||[]);
}

/* ===== 2. テーブル生成 ===== */
function buildTable(slots){
  const wrap = document.getElementById('tblWrap'); wrap.innerHTML='';
  if(slots.length===0){ wrap.textContent='候補日時が設定されていません'; return; }

  /* YYYY-MM-DD ごとにグループ化 */
  const grouped={};
  slots.forEach(s=>{
    const [d]=s.split(' ');
    (grouped[d]??=[]).push(s);
  });

  Object.keys(grouped).sort().forEach(date=>{
    wrap.insertAdjacentHTML('beforeend', `<h3>${date}</h3>`);
    const tbl=document.createElement('table');
    tbl.innerHTML='<tr><th>時間</th><th>可否</th></tr>';
    grouped[date].forEach(slot=>{
      const tr=document.createElement('tr');
      tr.insertAdjacentHTML('beforeend', `<td>${slot.split(' ')[1]}</td>`);
      const td=document.createElement('td');
      td.className='click'; td.dataset.slot=slot; td.textContent='〇';
      td.onclick=()=>{ td.textContent = marks[(marks.indexOf(td.textContent)+1)%marks.length]; };
      tr.appendChild(td); tbl.appendChild(tr);
    });
    wrap.appendChild(tbl);
  });
}

/* ===== 3. 送信 ===== */
document.getElementById('submitBtn').onclick = async ()=>{
  const name = document.getElementById('pName').value.trim();
  if(!name){ alert('名前を入力'); return; }

  const note = document.getElementById('noteInput').value.trim();
  const avail={};
  document.querySelectorAll('td.click').forEach(td=>{
    avail[td.dataset.slot]=td.textContent;
  });

  const res = await apiPost({
    mode   : 'answer',
    eventId: eventId,
    name   : name,
    choices: avail,
    note   : note
  });
  if(res.status==='success'){
    alert('送信しました。ご協力ありがとうございました。画面を閉じていただいて大丈夫です。');
    location.reload();
  }else alert('送信に失敗しました');
};

/* ===== 4. URLパラメータがあればすぐロード ===== */
if(eventId) loadEvent();
</script>
</body>
</html>
