<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>参加者画面</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#fafafa}
h2{margin:0 0 10px}
h3{margin:16px 0 6px}
button{padding:6px 14px;margin:4px;border:none;border-radius:4px;font-size:14px;cursor:pointer}
.primary{background:#1976d2;color:#fff}
td.click{cursor:pointer}
table{border-collapse:collapse;width:100%;font-size:12px;margin-bottom:12px}
th,td{border:1px solid #ccc;padding:4px;text-align:center}
.hidden{display:none}
</style>
</head>
<body>
<!-- ★イベント名 -->
<h2 id="title">参加可否の入力</h2>

<!-- ===== イベント選択 UI ===== -->
<div id="selectorWrap"></div>

<!-- ===== 参加入力 UI ===== -->
<div id="mainWrap" class="hidden">
  <p id="info"></p>
  <div>
    <label>お名前：<input type="text" id="pName"></label>
  </div>
  <div id="tblWrap" style="margin-top:10px"></div>
  <button id="submitBtn" class="primary">回答を送信</button>
</div>

<script>
/* ---------- 1) 共通設定 ---------- */
const marks=['','○','×'];                               // （△ を挿入したい場合はここに追加）
const qs=new URLSearchParams(location.search);
let id = qs.get('event');                               // URL パラメータ
let data=null;

/* ---------- 2) イベント選択 ---------- */
const selectorDiv=document.getElementById('selectorWrap');
function buildSelector(){
  const keys=Object.keys(localStorage).filter(k=>k.startsWith('event_'));
  if(keys.length===0){
    selectorDiv.innerHTML='<p>ローカルストレージにイベントがありません。先に開催者画面で作成してください。</p>';
    return;
  }
  const select=document.createElement('select');
  keys.forEach(k=>{
    const ev=JSON.parse(localStorage.getItem(k));
    const opt=document.createElement('option');
    opt.value=ev.id;
    opt.textContent=`${ev.id}（候補数:${ev.slots.length}）`;
    select.appendChild(opt);
  });
  const btn=document.createElement('button');
  btn.textContent='参加を開始';
  btn.className='primary';
  btn.onclick=()=>{ id=select.value; loadEvent(); };
  selectorDiv.appendChild(select);
  selectorDiv.appendChild(btn);
}

/* ---------- 3) メイン入力 ---------- */
function loadEvent(){
  data=JSON.parse(localStorage.getItem('event_'+id)||'null');
  if(!data){alert('イベントが存在しません');return;}

/* ★ タイトルにイベント名を反映 */
  document.getElementById('title').textContent = `「${data.eventName}」への参加入力`;

  selectorDiv.classList.add('hidden');
  document.getElementById('mainWrap').classList.remove('hidden');
  document.getElementById('info').textContent='イベントID: '+id;
  buildTable();
}

/* ====== ★ スロットを日付別にグルーピングしてテーブル生成 ====== */
function buildTable(){
  const wrap=document.getElementById('tblWrap');wrap.innerHTML='';
  if(data.slots.length===0){wrap.textContent='候補日時がまだ設定されていません';return;}

  // { "YYYY-MM-DD": [ "YYYY-MM-DD HH:MM", ... ] }
  const grouped={};
  data.slots.forEach(s=>{
    const [d]=s.split(' ');
    (grouped[d]??=[]).push(s);
  });

  Object.keys(grouped).sort().forEach(date=>{
    // 見出し
    const h3=document.createElement('h3');
    h3.textContent=date;
    wrap.appendChild(h3);

    // テーブル
    const tbl=document.createElement('table');
    const trHead=document.createElement('tr');
    trHead.innerHTML='<th>時間</th><th>可否</th>';
    tbl.appendChild(trHead);

    // 各スロット行
    grouped[date].forEach(slot=>{
      const tr=document.createElement('tr');
      tr.appendChild(document.createElement('td')).textContent=slot.split(' ')[1]; // 時刻部分のみ表示

      // クリックで ○→×→空
      const td=document.createElement('td');
      td.className='click';
      td.dataset.slot=slot;                          // 後で集計するため slot ID を保持
      td.onclick=()=>{td.textContent=marks[(marks.indexOf(td.textContent)+1)%marks.length];};
      tr.appendChild(td);

      tbl.appendChild(tr);
    });
    wrap.appendChild(tbl);
  });
}

/* ---------- 4) 回答送信 ---------- */
document.getElementById('submitBtn').onclick=()=>{
  const name=document.getElementById('pName').value.trim();
  if(!name){alert('名前を入力してください');return;}
  const cells=[...document.querySelectorAll('td.click')];
  const avail={};cells.forEach(td=>{avail[td.dataset.slot]=td.textContent;});
  data.participants.push({name,avail});
  localStorage.setItem('event_'+id,JSON.stringify(data));
  alert('送信しました。ご協力ありがとうございました。日程は決まり次第ご連絡いたします。');
  location.reload();
};

/* ---------- 5) 初期化 ---------- */
if(id){
  loadEvent();          // URL パラメータがあれば即ロード
}else{
  buildSelector();      // なければセレクタ表示
}
</script>
</body>
</html>
