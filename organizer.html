<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>開催者画面</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
/* ===== 既存デザインそのまま ===== */
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#fafafa}
h2{margin:0 0 10px}
h3{margin:16px 0 6px}
button{padding:6px 14px;margin:4px;border:none;border-radius:4px;font-size:14px;cursor:pointer}
.primary{background:#1976d2;color:#fff}
.secondary{background:#9e9e9e;color:#fff}
button:disabled{background:#cfd8dc}
.hidden{display:none}
.tabbtn{background:#e0e0e0;color:#000}
.tabbtn.active{background:#1976d2;color:#fff}
.section{margin-bottom:25px}
.times{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;margin-top:8px}
.slot{border:1px solid #ccc;border-radius:4px;font-size:12px;text-align:center;padding:4px 2px;user-select:none}
.slot.sel{background:#4caf50;border-color:#388e3c;color:#fff}
table{border-collapse:collapse;width:100%;font-size:12px}
th,td{border:1px solid #ccc;padding:4px;text-align:center}
td.clickable{cursor:pointer}
td.match{background:#81c784}
tr.hl td:not(.match){background:#fff59d}
button.del{background:none;border:none;color:#f44336;font-weight:bold;font-size:14px;cursor:pointer;padding:0 4px}
button.del:hover{color:#d32f2f}
</style>

<!-- ▼ GAS との通信ヘルパー -->
<script>
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxFvnUFdjhqrsLWccf5LMXILSX6BiaLJopmX5WSqpqfAwGvJ8qQaWz_0XTak5cLP0XW/exec';   // ★ ここを書き換える

  async function apiPost(body){
    const r = await fetch(ENDPOINT,{
      method:'POST',
      body:JSON.stringify(body)
    });
    return r.json();
  }
  async function apiGet(q){               // 例 'eventId=xxx&summary=1'
    const r = await fetch(`${ENDPOINT}?${q}`);
    return r.json();
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body>
<h2 id="title"></h2>

<!-- 上位タブ -->
<div class="section">
  <button class="tabbtn active" data-tab="status">参加状況</button>
  <button class="tabbtn" data-tab="result">調整結果</button>
  <button class="tabbtn" data-tab="setup">日程の追加</button>
</div>
<div id="tabDesc" style="margin:10px 0;font-size:13px;color:#333;"></div>

<!-- Ⅰ 参加状況 -->
<div id="status" class="section hidden">
  <div id="infoBox" style="margin-bottom:12px;font-size:13px;line-height:1.6;"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3 style="margin:0">参加状況</h3>
    <button id="refreshBtn" class="secondary">🔄 更新</button>
  </div>
  <div id="listTab"></div>
</div>

<!-- Ⅱ 調整結果 -->
<div id="result" class="section hidden">
  <div id="matchWrap"></div>
</div>
  
<!-- Ⅲ 日程追加 -->
<div id="setup" class="section">
  <div>
    <label>日付を選択：<input type="date" id="datePick"></label>
    <button class="secondary" id="addDateBtn">日付を追加</button>
  </div>
  <div id="dateBtns" style="margin:10px 0"></div>
  <div id="timeWrap">
    <h3 id="timeTitle">タイムスロット（8:00-19:00）</h3>
    <div id="timeGrid" class="times"></div>
  </div>
  <button id="sendBtn" class="primary" disabled>日程を送信</button>
  <p id="shareInfo" class="hidden"></p>
</div>

<script>
/* === 初期データ取得 === */
const qs  = new URLSearchParams(location.search);
const eventId = qs.get('event');
if(!eventId){ alert('event パラメータがありません'); history.back(); }

/* エベント情報 + 空参加者リスト */
let data = { title:'', slots:[], participants:[], matches:[] };

(async()=>{
  /* 1) イベント基本情報 */
  const ev = await apiGet('eventId='+eventId);
  if(ev.status==='not found'){ alert('イベントが存在しません'); history.back(); }
  data.title = ev.title;
  data.slots = ev.dates || [];

  /* 2) 参加者情報＋集計（summary=1 で participants も返す前提） */
  await refreshSummary();

  document.getElementById('title').textContent = '開催者画面 – '+data.title;
  initTabs();                      // UI 起動
  renderDateBtns();                // 既存スロットを反映
})();

/* === タブ切り替え === */
function initTabs(){
  document.querySelectorAll('.tabbtn').forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.dataset.tab;
      const desc = {
        setup : 'カレンダーから日付を追加 → 時間帯クリック → 送信',
        status: '○セルをクリックでマッチ選択。行をドラッグで順番変更',
        result: '選択済みマッチが一覧表示されます'
      };
      document.getElementById('tabDesc').innerText = desc[t]||'';
      ['result','status','setup'].forEach(id=>{
        document.getElementById(id).classList.toggle('hidden',id!==t);
      });
      if(t==='status') renderStatus();
      if(t==='result') renderResult();
    };
  });
  if(qs.get('tab')) document.querySelector(`[data-tab="${qs.get('tab')}"]`).click();
}

/* === 候補設定 === */
const times = (()=>{const a=[];for(let h=8;h<=19;h++){['00','30'].forEach(m=>{if(!(h===19&&m==='30'))a.push(`${String(h).padStart(2,'0')}:${m}`);});}return a;})();
const dateList = Object.fromEntries(data.slots.map(s=>{const [d,t]=s.split(' ');return [d,0];})); // 既存日付だけ鍵を用意
const dateBtnsDiv = document.getElementById('dateBtns');
const grid        = document.getElementById('timeGrid');

document.getElementById('addDateBtn').onclick = ()=>{
  const d = document.getElementById('datePick').value;
  if(!d) return;
  dateList[d] ??= new Set();
  renderDateBtns(d);
  renderGrid(d);
  document.getElementById('sendBtn').disabled=false;
};
function renderDateBtns(active){
  dateBtnsDiv.innerHTML='';
  Object.keys(dateList).sort().forEach(d=>{
    const b = document.createElement('button');
    b.textContent = d; b.className='secondary';
    if(d===active) b.style.fontWeight='bold';
    b.onclick = ()=>renderGrid(d);
    dateBtnsDiv.appendChild(b);
  });
}
function renderGrid(date){
  grid.innerHTML='';
  document.getElementById('timeTitle').textContent = date?`タイムスロット（${date}）`:'タイムスロット';
  times.forEach(t=>{
    const div = document.createElement('div');
    div.textContent=t; div.className='slot';
    if(dateList[date] && dateList[date].has(t)) div.classList.add('sel');
    div.onclick = ()=>{
      dateList[date] ??= new Set();
      if(dateList[date].has(t)){ dateList[date].delete(t); div.classList.remove('sel'); }
      else                    { dateList[date].add(t);    div.classList.add('sel');    }
    };
    grid.appendChild(div);
  });
}
document.getElementById('sendBtn').onclick = async ()=>{
  /* スロット配列を生成 */
  data.slots = [];
  Object.entries(dateList).forEach(([d,set])=>{
    if(set instanceof Set) set.forEach(t=>data.slots.push(`${d} ${t}`));
  });
  data.slots.sort();

  /* GAS へ保存 */
  const res = await apiPost({mode:'updateSlots',eventId,slots:data.slots});
  if(res.status==='success'){
    /* 共有 URL 表示 */
    const url = location.origin+location.pathname.replace('organizer.html','participant.html')+'?event='+eventId;
    const info = document.getElementById('shareInfo');
    info.textContent = '参加者用 URL: '+url;
    info.classList.remove('hidden');
    alert('候補日時を保存しました。参加者に URL を共有してください。');
    document.querySelector('.tabbtn[data-tab="status"]').click();
  }else alert('保存に失敗しました');
};

/* === 参加状況 === */
document.getElementById('refreshBtn').onclick = refreshSummary;

async function refreshSummary(){
  const r = await apiGet(`eventId=${eventId}&summary=1`);
  if(r.tally){ data.participants = r.participants||[]; } // tally だけでも良いが一覧用に participants も
}
function renderStatus(){
  /* infoBox */
  const orgUrl = location.origin+location.pathname+'?event='+eventId+'&tab=status';
  const parUrl = location.origin+location.pathname.replace('organizer.html','participant.html')+'?event='+eventId;
  document.getElementById('infoBox').innerHTML =
    `<strong>開催者URL:</strong> <a href="${orgUrl}" target="_blank">${orgUrl}</a><br>`+
    `<strong>参加者URL:</strong> <a href="${parUrl}" target="_blank">${parUrl}</a>`;

  /* スロット表 */
  const wrap=document.getElementById('listTab');wrap.innerHTML='';
  if(data.slots.length===0){wrap.textContent='候補がまだ設定されていません';return;}

  const grouped={};data.slots.forEach(s=>{const [d]=s.split(' ');(grouped[d]??=[]).push(s);});
  Object.keys(grouped).sort().forEach(date=>{
    const h3=document.createElement('h3');h3.textContent=date;wrap.appendChild(h3);
    const tbl=document.createElement('table');
    const thRow=document.createElement('tr');
    thRow.innerHTML='<th>参加者 / 時間</th>'+grouped[date].map(s=>`<th>${s.split(' ')[1]}</th>`).join('');
    tbl.appendChild(thRow);

    /* tbody */
    const tbody=document.createElement('tbody');tbl.appendChild(tbody);

    data.participants.forEach(p=>{
      const tr=document.createElement('tr');tr.dataset.name=p.name;
      /* 名前セル＋削除ボタン */
      const nameCell=document.createElement('td');nameCell.style.cursor='pointer';
      const del=document.createElement('button');del.textContent='🗑';del.className='del';del.onclick=()=>deleteParticipant(p.name);
      nameCell.append(p.name,' ',del);nameCell.onclick=()=>toggleHighlight(p.name);tr.appendChild(nameCell);
      /* 可否セル */
      grouped[date].forEach(s=>{
        const td = document.createElement('td');
const mark = p.avail ? p.avail[s] : '';
td.textContent = mark;

/* ○ と △ をクリック可能に */
if (mark === '〇' || mark === '△') {
  td.classList.add('clickable');
  if (isMatched(s, p.name)) td.classList.add('match');
  td.onclick = () => toggleMatch(s, p.name, td);
}
tr.appendChild(td);
    });

    /* 合計行 */
    const sum=document.createElement('tr');
    sum.innerHTML='<td>合計点</td>'+grouped[date].map(s=>{
      const tot=data.participants.reduce((a,p)=>a+(p.avail&&p.avail[s]==='○'?1:0),0);
      return `<td>${tot}</td>`;
    }).join('');
    tbl.appendChild(sum);
    wrap.appendChild(tbl);

    Sortable.create(tbody,{
      animation:150,
      onEnd:()=>{
        const order=[...tbody.querySelectorAll('tr')].map(r=>r.dataset.name);
        data.participants.sort((a,b)=>order.indexOf(a.name)-order.indexOf(b.name));
        renderResult();
      }
    });
  });
}
function safeMark(m){return m||'';}
function toggleHighlight(name){
  document.querySelectorAll(`tr[data-name="${name}"]`).forEach(r=>r.classList.toggle('hl'));
}
function deleteParticipant(name){
  if(!confirm(name+' さんの回答を削除しますか？')) return;
  data.participants=data.participants.filter(p=>p.name!==name);
  // ★ここではサーバー削除API未実装のためフロントのみ
  renderStatus();renderResult();
}
/* ===== マッチ操作 ===== */
function isMatched(slot, name){
  return data.matches.some(m => m.slot === slot && m.name === name);
}
function toggleMatch(slot, name, cell){
  if (isMatched(slot, name)){
    data.matches = data.matches.filter(m => !(m.slot===slot && m.name===name));
    cell.classList.remove('match');
  }else{
    data.matches.push({slot, name});
    cell.classList.add('match');
  }
  renderResult();                  // ← 毎回結果を再描画
}

/* === 調整結果（単純リスト） === */
/* ===== 調整結果タブ ===== */
function renderResult(){
  const div = document.getElementById('matchWrap');
  div.innerHTML = '';

  if (data.matches.length === 0){
    div.textContent = 'まだマッチが選択されていません。「参加状況」タブで ○ または △ セルをクリックしてください。';
    return;
  }

  /* {slot:[name,…]} にまとめて表示 */
  const grouped = {};
  data.matches.forEach(m => (grouped[m.slot] ??= []).push(m.name));

  Object.keys(grouped).sort().forEach(slot=>{
    const h3 = document.createElement('h3');
    h3.textContent = slot;
    div.appendChild(h3);

    const ul = document.createElement('ul');
    grouped[slot].forEach(n=>{
      const li = document.createElement('li');
      li.textContent = n;
      ul.appendChild(li);
    });
    div.appendChild(ul);
  });
}
</script>
</body>
</html>
