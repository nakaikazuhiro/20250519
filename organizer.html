<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>開催者画面</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#fafafa}
h2{margin:0 0 10px}
h3{margin:16px 0 6px}
button{padding:6px 14px;margin:4px;border:none;border-radius:4px;font-size:14px;cursor:pointer}
.primary{background:#1976d2;color:#fff}
.secondary{background:#9e9e9e;color:#fff}
button:disabled{background:#cfd8dc}
.hidden{display:none}
.tabbtn{background:#e0e0e0;color:#000}
.tabbtn.active{background:#1976d2;color:#fff}
.section{margin-bottom:25px}
.times{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;margin-top:8px}
.slot{border:1px solid #ccc;border-radius:4px;font-size:12px;text-align:center;padding:4px 2px;user-select:none}
.slot.sel{background:#4caf50;border-color:#388e3c;color:#fff}
table{border-collapse:collapse;width:100%;font-size:12px}
th,td{border:1px solid #ccc;padding:4px;text-align:center}
td.clickable{cursor:pointer}
td.match{background:#81c784}
tr.hl td:not(.match){background:#fff59d}

/* ★ 追加：ごみ箱ボタン */
button.del{background:none;border:none;color:#f44336;font-weight:bold;font-size:14px;cursor:pointer;padding:0 4px}
button.del:hover{color:#d32f2f}
</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>  
</head>
<body>
<h2 id="title"></h2>

<!-- 上位タブ -->
<div class="section">
  <button class="tabbtn active" data-tab="setup">候補設定</button>
  <button class="tabbtn" data-tab="status">参加状況</button>
  <button class="tabbtn" data-tab="result">調整結果</button>
</div>
<!-- 説明文 -->
<div id="tabDesc" style="margin:10px 0; font-size:13px; color:#333;"></div>
  
<!-- Ⅰ 候補設定 -->
<div id="setup" class="section">
  <div>
    <label>日付を選択：<input type="date" id="datePick"></label>
    <button class="secondary" id="addDateBtn">日付を追加</button>
  </div>
  <div id="dateBtns" style="margin:10px 0"></div>
  <div id="timeWrap">
    <h3 id="timeTitle">タイムスロット（8:00-19:00）</h3>
    <div id="timeGrid" class="times"></div>
  </div>
  <button id="sendBtn" class="primary" disabled>日程を送信</button>
  <p id="shareInfo" class="hidden"></p>
</div>

<!-- Ⅱ 参加状況 -->
<div id="status" class="section hidden">
  <div id="infoBox" style="margin-bottom:12px;font-size:13px;line-height:1.6;"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3 style="margin:0">参加状況</h3>
    <button id="refreshBtn" class="secondary">🔄 更新</button> <!-- ★追加 -->
  </div>
  <div id="listTab"></div>
  <button id="csvBtn" class="secondary">（使用不可）CSVダウンロード</button>
</div>

<!-- Ⅲ 調整結果 -->
<div id="result" class="section hidden">
  <div id="matchWrap"></div>
</div>

<script>
/* ===== 共通 ===== */
const qs=new URLSearchParams(location.search);
const eventId=qs.get('event');
let data=JSON.parse(localStorage.getItem('event_'+eventId)||'null');
if(!eventId||!data){alert('イベントが存在しません');history.back();}
if(!Array.isArray(data.matches)) data.matches=[];

/* ★ タイトルにイベント名を反映 */
document.getElementById('title').textContent = `開催者画面 – ${data.eventName}`;

/* ===== タブ切替 ===== */
document.querySelectorAll('.tabbtn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t=btn.dataset.tab;
    // 説明文を表示
　　　const desc = {
  setup: "使い方：カレンダーから日付を選ぶ→日付を追加をクリック→時間帯をクリック→これを繰り返し、選択が終われば日程を送信",
  status: "使い方：○をクリックすると【調整結果】タブに反映されます。参加者名をドラッグで順番の入れ、クリックでハイライトできます。",
  result: "【参加状況】タブでの結果が一覧で表示されます。"
};
document.getElementById('tabDesc').innerText = desc[t] || '';
    ['setup','status','result'].forEach(id=>document.getElementById(id).classList.toggle('hidden',id!==t));
    if(t==='status') renderStatus();
    if(t==='result') renderResult();
  };
});
if(qs.get('tab')==='status') document.querySelector('.tabbtn[data-tab="status"]').click();
if(qs.get('tab')==='result') document.querySelector('.tabbtn[data-tab="result"]').click();

/* ===== Ⅰ 候補設定 ===== */
const times=(()=>{let a=[];for(let h=8;h<=19;h++){['00','30'].forEach(m=>{if(!(h===19&&m==='30'))a.push(`${String(h).padStart(2,'0')}:${m}`);});}return a;})();
const dateList={},dateBtnsDiv=document.getElementById('dateBtns'),grid=document.getElementById('timeGrid');

document.getElementById('addDateBtn').onclick=()=>{
  const d=document.getElementById('datePick').value;if(!d)return;
  if(!dateList[d]) dateList[d]=new Set();
  renderDateBtns(d);renderGrid(d);document.getElementById('sendBtn').disabled=false;
};
function renderDateBtns(active){dateBtnsDiv.innerHTML='';Object.keys(dateList).sort().forEach(d=>{const b=document.createElement('button');b.textContent=d;b.className='secondary';if(d===active) b.style.fontWeight='bold';b.onclick=()=>renderGrid(d);dateBtnsDiv.appendChild(b);});}
function renderGrid(date){grid.innerHTML='';document.getElementById('timeTitle').textContent=date?`タイムスロット（${date}）`:'タイムスロット';times.forEach(t=>{const div=document.createElement('div');div.textContent=t;div.className='slot';if(dateList[date].has(t))div.classList.add('sel');div.onclick=()=>{if(dateList[date].has(t)){dateList[date].delete(t);div.classList.remove('sel');}else{dateList[date].add(t);div.classList.add('sel');}};grid.appendChild(div);});}
document.getElementById('sendBtn').onclick=()=>{data.slots=[];Object.entries(dateList).forEach(([d,set])=>set.forEach(t=>data.slots.push(`${d} ${t}`)));data.slots.sort();localStorage.setItem('event_'+eventId,JSON.stringify(data));const url=location.origin+location.pathname.replace('organizer.html','participant.html')+'?event='+eventId;const info=document.getElementById('shareInfo');info.textContent='参加者用 URL: '+url;info.classList.remove('hidden');alert('候補日時を保存しました。参加者に URL を共有してください。');document.querySelector('.tabbtn[data-tab="status"]').click();};

  
  /* ===== Ⅱ 参加状況 ===== */
function renderStatus(){
  /* ★ infoBox の内容を更新する ---------------- */
  const info = document.getElementById('infoBox');
  if (info) {
    // 開催者URL = 今表示しているページ
    const organizerUrl =
      location.origin + location.pathname + '?event=' + eventId + '&tab=status';
    // 参加者URL
    const participantUrl =
      location.origin +
      location.pathname.replace('organizer.html', 'participant.html') +
      '?event=' + eventId;

    // 候補日程を "YYYY-MM-DD HH:MM" 形式でカンマ区切り表示
    // ※ここから ▼ 差し替え ▼
let slotsHtml;
if (data.slots && data.slots.length) {
  // { "YYYY-MM-DD": ["HH:MM", ...] } へグルーピング
  const grouped = {};
  data.slots.forEach(s => {
    const [d, t] = s.split(' ');
    (grouped[d] ??= []).push(t);
  });

  // HTML テーブル化（年は落とし、日付昇順）
  slotsHtml = '<table style="border-collapse:collapse;font-size:13px;">' +
    Object.entries(grouped)
      .sort(([a], [b]) => a.localeCompare(b))
      .map(([d, arr]) => {
        const mmdd = d.slice(5); // "YYYY-MM-DD" → "MM-DD"
        const cells = arr.map(t => `<td style="border:1px solid #ccc;padding:2px 6px;">${t}</td>`).join('');
        return `<tr><td style="border:1px solid #ccc;padding:2px 6px;font-weight:bold;">${mmdd}</td>${cells}</tr>`;
      })
      .join('') +
    '</table>';
} else {
  slotsHtml = '（まだ候補がありません）';
}
// ▲ 差し替えここまで


    info.innerHTML =
      `<strong>開催者URL:</strong> <a href="${organizerUrl}" target="_blank">${organizerUrl}</a><br>` +
      `<strong>参加者URL:</strong> <a href="${participantUrl}" target="_blank">${participantUrl}</a><br>` +
      `<strong>候補日程:</strong> ${slotsHtml}`;
  }
  const wrap=document.getElementById('listTab');wrap.innerHTML='';
  if(data.slots.length===0){wrap.textContent='候補がまだ設定されていません';return;}
  const grouped={};data.slots.forEach(s=>{const [d]=s.split(' ');(grouped[d]??=[]).push(s);});
  Object.keys(grouped).sort().forEach(date=>{
    const h3=document.createElement('h3');h3.textContent=date;wrap.appendChild(h3);
    const tbl=document.createElement('table');
    const thRow=document.createElement('tr');thRow.appendChild(document.createElement('th')).textContent='参加者 / 時間';
    grouped[date].forEach(s=>{const th=document.createElement('th');th.textContent=s.split(' ')[1];thRow.appendChild(th);});tbl.appendChild(thRow);
    const tbody = document.createElement('tbody');
tbody.id = 'participantRows_' + date;
tbl.appendChild(tbody);

data.participants.forEach(p => {
  const tr = document.createElement('tr');
  tr.dataset.name = p.name;

  const nameCell = document.createElement('td');
  const delBtn = document.createElement('button');
  delBtn.textContent = '🗑';
  delBtn.className = 'del';
  delBtn.title = 'この参加者を削除';
  delBtn.onclick = () => deleteParticipant(p.name);
  nameCell.append(p.name, ' ', delBtn);
  nameCell.style.cursor = 'pointer';
  nameCell.onclick = () => toggleHighlight(p.name);
  tr.appendChild(nameCell);

  grouped[date].forEach(s => {
    const td = document.createElement('td');
    const mark = p.avail[s] || '';
    td.textContent = mark;
    if (mark === '○') {
      td.classList.add('clickable');
      if (isMatched(s, p.name)) td.classList.add('match');
      td.onclick = () => toggleMatch(s, p.name, td);
    }
    tr.appendChild(td);
  });

  tbody.appendChild(tr);
});

Sortable.create(tbody, {
  animation: 150,
  onEnd: () => {
    const rows = [...tbody.querySelectorAll('tr')];
    const names = rows.map(r => r.dataset.name);
    data.participants.sort((a, b) => names.indexOf(a.name) - names.indexOf(b.name));
    localStorage.setItem('event_' + eventId, JSON.stringify(data));
    renderResult();
  }
});

    const sumRow=document.createElement('tr');sumRow.appendChild(document.createElement('td')).textContent='合計点';
    grouped[date].forEach(s=>{const total=data.participants.reduce((a,p)=>a+(p.avail[s]==='○'?1:0),0);sumRow.appendChild(document.createElement('td')).textContent=total;});
    tbl.appendChild(sumRow);wrap.appendChild(tbl);
  });
}

function toggleHighlight(name){document.querySelectorAll(`#listTab tr[data-name="${name}"]`).forEach(r=>r.classList.toggle('hl'));}
function isMatched(slot,name){return data.matches.some(m=>m.slot===slot&&m.name===name);}
function toggleMatch(slot,name,cell){if(isMatched(slot,name)){data.matches=data.matches.filter(m=>!(m.slot===slot&&m.name===name));cell.classList.remove('match');}else{data.matches.push({slot,name});cell.classList.add('match');}localStorage.setItem('event_'+eventId,JSON.stringify(data));}

/* ★ 参加者削除処理 */
function deleteParticipant(name){
  if(!confirm(`${name} さんの回答を削除しますか？`)) return;
  data.participants=data.participants.filter(p=>p.name!==name);
  data.matches=data.matches.filter(m=>m.name!==name);
  localStorage.setItem('event_'+eventId,JSON.stringify(data));
  renderStatus();renderResult();
}

/* ===== Ⅲ 調整結果 ===== */
function renderResult(){
  const div=document.getElementById('matchWrap');div.innerHTML='';
  if(data.matches.length===0){div.textContent='まだマッチが選択されていません。参加状況タブで○セルをクリックしてください。';return;}
  const grouped={};data.matches.forEach(m=>(grouped[m.slot]??=[]).push(m.name));
  Object.keys(grouped).sort().forEach(slot=>{const h3=document.createElement('h3');h3.textContent=slot;div.appendChild(h3);const ul=document.createElement('ul');grouped[slot].forEach(n=>{const li=document.createElement('li');li.textContent=n;ul.appendChild(li);});div.appendChild(ul);});
}

// 🔄 更新ボタンの処理
document.getElementById('refreshBtn').onclick = () => {
  const snap = localStorage.getItem('event_' + eventId);
  if (snap) {
    data = JSON.parse(snap);
    renderStatus();      // 参加状況を再描画
    renderResult();      // 調整結果も再描画
  } else {
    alert('データが見つかりません。');
  }
};
  
/* ===== CSV ===== */
document.getElementById('csvBtn').onclick=()=>{let csv='参加者,'+data.slots.join(',')+'\n';data.participants.forEach(p=>csv+=p.name+','+data.slots.map(s=>p.avail[s]||'').join(',')+'\n');csv+='合計点,'+data.slots.map(s=>data.participants.reduce((a,p)=>a+(p.avail[s]==='○'?1:0),0)).join(',')+'\n';const blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='schedule_'+eventId+'.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);};
</script>
</body>
</html>
