<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é–‹å‚¬è€…ç”»é¢</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
/* ===== åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ ===== */
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#fafafa}
h2{margin:0 0 10px}
h3{margin:16px 0 6px}
button{padding:6px 14px;margin:4px;border:none;border-radius:4px;font-size:14px;cursor:pointer}
.primary{background:#1976d2;color:#fff}
.secondary{background:#9e9e9e;color:#fff}
button:disabled{background:#cfd8dc}
.hidden{display:none}
.tabbtn{background:#e0e0e0;color:#000}
.tabbtn.active{background:#1976d2;color:#fff}
.section{margin-bottom:25px}
.times{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;margin-top:8px}
.slot{border:1px solid #ccc;border-radius:4px;font-size:12px;text-align:center;padding:4px 2px;user-select:none}
.slot.sel{background:#4caf50;border-color:#388e3c;color:#fff}

/* ===== å‚åŠ çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ« ===== */
table{border-collapse:collapse;width:100%;font-size:12px;table-layout:fixed}
th,td{border:1px solid #ccc;padding:4px;text-align:center;min-width:52px}
.gray{background:#e0e0e0;color:#888}
td.match{background:#81c784}
tr.hl td:not(.match){background:#fff59d}
button.del{background:none;border:none;color:#f44336;font-weight:bold;font-size:14px;cursor:pointer;padding:0 4px}
button.del:hover{color:#d32f2f}
</style>

<!-- â–¼ GAS ã¨ã®é€šä¿¡ãƒ˜ãƒ«ãƒ‘ãƒ¼ -->
<script>
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxFvnUFdjhqrsLWccf5LMXILSX6BiaLJopmX5WSqpqfAwGvJ8qQaWz_0XTak5cLP0XW/exec';   // â˜… å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´

  async function apiPost(body){
    const r = await fetch(ENDPOINT,{method:'POST',body:JSON.stringify(body)});
    return r.json();
  }
  async function apiGet(q){              // ä¾‹ 'eventId=xxx&summary=1'
    const r = await fetch(`${ENDPOINT}?${q}`);
    return r.json();
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
<h2 id="title"></h2>

<!-- ä¸Šä½ã‚¿ãƒ– -->
<div class="section">
  <button class="tabbtn" data-tab="status">å‚åŠ çŠ¶æ³</button>
  <button class="tabbtn" data-tab="result">èª¿æ•´çµæœ</button>
  <button class="tabbtn" data-tab="setup">å€™è£œæ—¥ç¨‹ã®è¿½åŠ </button>
</div>
<div id="tabDesc" style="margin:10px 0;font-size:13px;color:#333;"></div>

<!-- â…  å‚åŠ çŠ¶æ³ -->
<div id="status" class="section hidden">
  <div id="infoBox" style="margin-bottom:12px;font-size:13px;line-height:1.6;"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3 style="margin:0">å‚åŠ çŠ¶æ³</h3>
    <button id="refreshBtn" class="secondary">ğŸ”„ æ›´æ–°</button>
  </div>
  <div id="listTab"></div>
</div>

<!-- â…¡ èª¿æ•´çµæœ -->
<div id="result" class="section hidden"><div id="matchWrap"></div></div>

<!-- â…¢ æ—¥ç¨‹è¿½åŠ  -->
<div id="setup" class="section">
  <div>
    <label>æ—¥ä»˜ã‚’é¸æŠï¼š<input type="date" id="datePick"></label>
    <button class="secondary" id="addDateBtn">æ—¥ä»˜ã‚’è¿½åŠ </button>
  </div>
  <div id="dateBtns" style="margin:10px 0"></div>
  <div id="timeWrap">
    <h3 id="timeTitle">ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ9:00â€‘18:00ï¼‰</h3>
    <div id="timeGrid" class="times"></div>
  </div>
  <button id="sendBtn" class="primary" disabled>æ—¥ç¨‹ã‚’é€ä¿¡</button>
  <p id="shareInfo" class="hidden"></p>
</div>

<script>
/********* å®šæ•° & ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ *********/
const FIXED_TIMES = [
  '09:00','09:30','11:00','11:30','12:00','12:30',
  '14:00','14:30','15:00','15:30','17:00','17:30'
];
function score(mark){
  return mark==='â—‹'?1:mark==='â–³'?0.5:0;
}
function safeMark(m){return m||'';}

/********* åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾— *********/
const qs = new URLSearchParams(location.search);
const eventId = qs.get('event');
if(!eventId){ alert('event ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); history.back(); }

let data = { title:'', slots:[], participants:[] };

(async ()=>{
  // 1) ã‚¤ãƒ™ãƒ³ãƒˆåŸºæœ¬æƒ…å ±
  const ev = await apiGet('eventId='+eventId);
  if(ev.status==='not found'){ alert('ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“'); history.back(); }
  data.title = ev.title;
  data.slots = ev.dates || [];

  // 2) å‚åŠ è€…æƒ…å ±
  await refreshSummary();

  document.getElementById('title').textContent = 'é–‹å‚¬è€…ç”»é¢ â€“ '+data.title;
  initTabs();
  renderDateBtns();
})();

/********* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ *********/
function initTabs(){
  document.querySelectorAll('.tabbtn').forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.dataset.tab;
      const desc = {
        setup :'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’è¿½åŠ  â†’ æ™‚é–“å¸¯ã‚¯ãƒªãƒƒã‚¯ â†’ é€ä¿¡',
        status:'å‚åŠ è€…ã®å¯å¦ã¨åˆè¨ˆç‚¹ã‚’ç¢ºèªã§ãã¾ã™',
        result:'ãƒãƒƒãƒã—ãŸæ—¥æ™‚ã®ä¸€è¦§'
      };
      document.getElementById('tabDesc').textContent = desc[t]||'';
      ['result','status','setup'].forEach(id=>{
        document.getElementById(id).classList.toggle('hidden',id!==t);
      });
      if(t==='status') renderStatus();
      if(t==='result') renderResult();
    };
  });
  // æ—¢å®šã‚’ã€Œå‚åŠ çŠ¶æ³ã€ã‚¿ãƒ–ã«
  const defaultTab = qs.get('tab') || 'status';
  document.querySelector(`.tabbtn[data-tab="${defaultTab}"]`).click();
}

/********* å€™è£œæ—¥ç¨‹è¿½åŠ ï¼ˆå¾“æ¥ãƒ­ã‚¸ãƒƒã‚¯ã®ã¾ã¾ï¼‰ *********/
const fullTimes = (()=>{const a=[];for(let h=9;h<=18;h++){['00','30'].forEach(m=>{if(!(h===18&&m==='30'))a.push(`${String(h).padStart(2,'0')}:${m}`);});}return a;})();
const dateList = {};
const dateBtnsDiv = document.getElementById('dateBtns');
const grid = document.getElementById('timeGrid');

function renderDateBtns(active){
  dateBtnsDiv.innerHTML='';
  Object.keys(dateList).sort().forEach(d=>{
    const b=document.createElement('button');
    b.textContent=d; b.className='secondary';
    if(d===active) b.style.fontWeight='bold';
    b.onclick=()=>renderGrid(d);
    dateBtnsDiv.appendChild(b);
  });
}
function renderGrid(date){
  grid.innerHTML='';
  document.getElementById('timeTitle').textContent = date?`ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ${date}ï¼‰`:'ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆ';
  fullTimes.forEach(t=>{
    const div=document.createElement('div');
    div.textContent=t; div.className='slot';
    if(dateList[date]?.has(t)) div.classList.add('sel');
    div.onclick=()=>{
      dateList[date]??=new Set();
      if(dateList[date].has(t)){ dateList[date].delete(t); div.classList.remove('sel'); }
      else                     { dateList[date].add(t);   div.classList.add('sel');    }
    };
    grid.appendChild(div);
  });
}

document.getElementById('addDateBtn').onclick = ()=>{
  const d=document.getElementById('datePick').value;
  if(!d) return;
  dateList[d]??=new Set();
  renderDateBtns(d);
  renderGrid(d);
  document.getElementById('sendBtn').disabled=false;
};

document.getElementById('sendBtn').onclick = async ()=>{
  data.slots=[];
  Object.entries(dateList).forEach(([d,set])=>{set.forEach(t=>data.slots.push(`${d} ${t}`));});
  data.slots.sort();
  const res = await apiPost({mode:'updateSlots',eventId,slots:data.slots});
  if(res.status==='success'){
    const url = location.origin+location.pathname.replace('organizer.html','participant.html')+`?event=${eventId}`;
    const info=document.getElementById('shareInfo');
    info.textContent='å‚åŠ è€…ç”¨ URL: '+url;
    info.classList.remove('hidden');
    alert('å€™è£œæ—¥æ™‚ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚å‚åŠ è€…ã« URL ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚');
    document.querySelector('.tabbtn[data-tab="status"]').click();
  }else alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
};

/********* å‚åŠ çŠ¶æ³ *********/
document.getElementById('refreshBtn').onclick = refreshSummary;
async function refreshSummary(){
  const r = await apiGet(`eventId=${eventId}&summary=1`);
  if(r){ data.participants = r.participants || []; }
}

function renderStatus(){
  // é–‹å‚¬è€…ãƒ»å‚åŠ è€… URL
  const orgUrl = location.origin+location.pathname+`?event=${eventId}&tab=status`;
  const parUrl = location.origin+location.pathname.replace('organizer.html','participant.html')+`?event=${eventId}`;
  document.getElementById('infoBox').innerHTML =
    `<strong>é–‹å‚¬è€…URL:</strong> <a href="${orgUrl}" target="_blank">${orgUrl}</a><br>`+
    `<strong>å‚åŠ è€…URL:</strong> <a href="${parUrl}" target="_blank">${parUrl}</a>`;

  // ã‚¹ãƒ­ãƒƒãƒˆè¡¨ç”Ÿæˆ
  const wrap = document.getElementById('listTab');
  wrap.innerHTML='';
  if(data.slots.length===0){wrap.textContent='å€™è£œãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';return;}

  // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const grouped={};
  data.slots.forEach(s=>{const [d] = s.split(' '); (grouped[d]??=[]).push(s);});

  Object.keys(grouped).sort().forEach(date=>{
    const timesSet = new Set(grouped[date].map(s=>s.split(' ')[1]));

    const h3=document.createElement('h3');h3.textContent=date;wrap.appendChild(h3);
    const tbl=document.createElement('table');
    const thead=document.createElement('tr');
    thead.innerHTML = '<th>å‚åŠ è€… / é–‹å§‹æ™‚é–“</th>' + FIXED_TIMES.map(t=>`<th>${t}</th>`).join('');
    tbl.appendChild(thead);

    const tbody=document.createElement('tbody');
    // å„å‚åŠ è€…è¡Œ
    data.participants.forEach(p=>{
      const tr=document.createElement('tr'); tr.dataset.name=p.name;
      const nameTd=document.createElement('td');
      const del=document.createElement('button'); del.textContent='ğŸ—‘'; del.className='del'; del.onclick=()=>deleteParticipant(p.name);
      nameTd.append(p.name,' ',del); nameTd.style.cursor='pointer'; nameTd.onclick=()=>toggleHighlight(p.name);
      tr.appendChild(nameTd);

      FIXED_TIMES.forEach(t=>{
        const td=document.createElement('td');
        if(!timesSet.has(t)) td.className='gray';
        const key=`${date} ${t}`;
        td.textContent = timesSet.has(t) ? safeMark(p.avail?.[key]) : '';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    // ä¸¦ã¹æ›¿ãˆå¯èƒ½
    Sortable.create(tbody,{animation:150,onEnd:()=>{
      const order=[...tbody.querySelectorAll('tr')].map(r=>r.dataset.name);
      data.participants.sort((a,b)=>order.indexOf(a.name)-order.indexOf(b.name));
      renderResult();
    }});
  });
}
function toggleHighlight(name){
  document.querySelectorAll(`tr[data-name="${name}"]`).forEach(r=>r.classList.toggle('hl'));
}
function deleteParticipant(name){
  if(!confirm(`${name} ã•ã‚“ã®å›ç­”ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  data.participants = data.participants.filter(p=>p.name!==name);
  renderStatus(); renderResult();
}

/********* èª¿æ•´çµæœ *********/
function renderResult(){
  const div=document.getElementById('matchWrap'); div.innerHTML='';
  if(data.participants.length===0){div.textContent='ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“';return;}
  const tally={};
  data.participants.forEach(p=>{
    if(!p.avail) return;
    Object.entries(p.avail).forEach(([slot,mark])=>{ if(mark==='â—‹') (tally[slot]=tally[slot]||[]).push(p.name); });
  });
  Object.keys(tally).sort().forEach(slot=>{
    const h3=document.createElement('h3'); h3.textContent=slot; div.appendChild(h3);
    const ul=document.createElement('ul');
    tally[slot].forEach(n=>{const li=document.createElement('li'); li.textContent=n; ul.appendChild(li);});
    div.appendChild(ul);
  });
}
</script>
</body>
</html>
