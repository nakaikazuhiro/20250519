<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é–‹å‚¬è€…ç”»é¢</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#fafafa}
h2{margin:0 0 10px}
h3{margin:16px 0 6px}
button{padding:6px 14px;margin:4px;border:none;border-radius:4px;font-size:14px;cursor:pointer}
.primary{background:#1976d2;color:#fff}
.secondary{background:#9e9e9e;color:#fff}
button:disabled{background:#cfd8dc}
.hidden{display:none}
.tabbtn{background:#e0e0e0;color:#000}
.tabbtn.active{background:#1976d2;color:#fff}
.section{margin-bottom:25px}
.times{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;margin-top:8px}
.slot{border:1px solid #ccc;border-radius:4px;font-size:12px;text-align:center;padding:4px 2px;user-select:none}
.slot.sel{background:#4caf50;border-color:#388e3c;color:#fff}
table{border-collapse:collapse;width:100%;font-size:12px}
th,td{border:1px solid #ccc;padding:4px;text-align:center}
td.clickable{cursor:pointer}
td.match{background:#81c784}
tr.hl td:not(.match){background:#fff59d}

/* â˜… è¿½åŠ ï¼šã”ã¿ç®±ãƒœã‚¿ãƒ³ */
button.del{background:none;border:none;color:#f44336;font-weight:bold;font-size:14px;cursor:pointer;padding:0 4px}
button.del:hover{color:#d32f2f}
</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>  
</head>
<body>
<h2 id="title"></h2>

<!-- ä¸Šä½ã‚¿ãƒ– -->
<div class="section">
  <button class="tabbtn active" data-tab="setup">å€™è£œè¨­å®š</button>
  <button class="tabbtn" data-tab="status">å‚åŠ çŠ¶æ³</button>
  <button class="tabbtn" data-tab="result">èª¿æ•´çµæœ</button>
</div>
<!-- èª¬æ˜æ–‡ -->
<div id="tabDesc" style="margin:10px 0; font-size:13px; color:#333;"></div>
  
<!-- â…  å€™è£œè¨­å®š -->
<div id="setup" class="section">
  <div>
    <label>æ—¥ä»˜ã‚’é¸æŠï¼š<input type="date" id="datePick"></label>
    <button class="secondary" id="addDateBtn">æ—¥ä»˜ã‚’è¿½åŠ </button>
  </div>
  <div id="dateBtns" style="margin:10px 0"></div>
  <div id="timeWrap">
    <h3 id="timeTitle">ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ8:00-19:00ï¼‰</h3>
    <div id="timeGrid" class="times"></div>
  </div>
  <button id="sendBtn" class="primary" disabled>æ—¥ç¨‹ã‚’é€ä¿¡</button>
  <p id="shareInfo" class="hidden"></p>
</div>

<!-- â…¡ å‚åŠ çŠ¶æ³ -->
<div id="status" class="section hidden">
  <div id="infoBox" style="margin-bottom:12px;font-size:13px;line-height:1.6;"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3 style="margin:0">å‚åŠ çŠ¶æ³</h3>
    <button id="refreshBtn" class="secondary">ğŸ”„ æ›´æ–°</button> <!-- â˜…è¿½åŠ  -->
  </div>
  <div id="listTab"></div>
  <button id="csvBtn" class="secondary">ï¼ˆä½¿ç”¨ä¸å¯ï¼‰CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
</div>

<!-- â…¢ èª¿æ•´çµæœ -->
<div id="result" class="section hidden">
  <div id="matchWrap"></div>
</div>

<script>
/* ===== å…±é€š ===== */
const qs=new URLSearchParams(location.search);
const eventId=qs.get('event');
let data=JSON.parse(localStorage.getItem('event_'+eventId)||'null');
if(!eventId||!data){alert('ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“');history.back();}
if(!Array.isArray(data.matches)) data.matches=[];

/* â˜… ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚¤ãƒ™ãƒ³ãƒˆåã‚’åæ˜  */
document.getElementById('title').textContent = `é–‹å‚¬è€…ç”»é¢ â€“ ${data.eventName}`;

/* ===== ã‚¿ãƒ–åˆ‡æ›¿ ===== */
document.querySelectorAll('.tabbtn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t=btn.dataset.tab;
    // èª¬æ˜æ–‡ã‚’è¡¨ç¤º
ã€€ã€€ã€€const desc = {
  setup: "ä½¿ã„æ–¹ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸ã¶â†’æ—¥ä»˜ã‚’è¿½åŠ ã‚’ã‚¯ãƒªãƒƒã‚¯â†’æ™‚é–“å¸¯ã‚’ã‚¯ãƒªãƒƒã‚¯â†’ã“ã‚Œã‚’ç¹°ã‚Šè¿”ã—ã€é¸æŠãŒçµ‚ã‚ã‚Œã°æ—¥ç¨‹ã‚’é€ä¿¡",
  status: "ä½¿ã„æ–¹ï¼šâ—‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€èª¿æ•´çµæœã€‘ã‚¿ãƒ–ã«åæ˜ ã•ã‚Œã¾ã™ã€‚å‚åŠ è€…åã‚’ãƒ‰ãƒ©ãƒƒã‚°ã§é †ç•ªã®å…¥ã‚Œã€ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã§ãã¾ã™ã€‚",
  result: "ã€å‚åŠ çŠ¶æ³ã€‘ã‚¿ãƒ–ã§ã®çµæœãŒä¸€è¦§ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"
};
document.getElementById('tabDesc').innerText = desc[t] || '';
    ['setup','status','result'].forEach(id=>document.getElementById(id).classList.toggle('hidden',id!==t));
    if(t==='status') renderStatus();
    if(t==='result') renderResult();
  };
});
if(qs.get('tab')==='status') document.querySelector('.tabbtn[data-tab="status"]').click();
if(qs.get('tab')==='result') document.querySelector('.tabbtn[data-tab="result"]').click();

/* ===== â…  å€™è£œè¨­å®š ===== */
const times=(()=>{let a=[];for(let h=8;h<=19;h++){['00','30'].forEach(m=>{if(!(h===19&&m==='30'))a.push(`${String(h).padStart(2,'0')}:${m}`);});}return a;})();
const dateList={},dateBtnsDiv=document.getElementById('dateBtns'),grid=document.getElementById('timeGrid');

document.getElementById('addDateBtn').onclick=()=>{
  const d=document.getElementById('datePick').value;if(!d)return;
  if(!dateList[d]) dateList[d]=new Set();
  renderDateBtns(d);renderGrid(d);document.getElementById('sendBtn').disabled=false;
};
function renderDateBtns(active){dateBtnsDiv.innerHTML='';Object.keys(dateList).sort().forEach(d=>{const b=document.createElement('button');b.textContent=d;b.className='secondary';if(d===active) b.style.fontWeight='bold';b.onclick=()=>renderGrid(d);dateBtnsDiv.appendChild(b);});}
function renderGrid(date){grid.innerHTML='';document.getElementById('timeTitle').textContent=date?`ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ${date}ï¼‰`:'ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆ';times.forEach(t=>{const div=document.createElement('div');div.textContent=t;div.className='slot';if(dateList[date].has(t))div.classList.add('sel');div.onclick=()=>{if(dateList[date].has(t)){dateList[date].delete(t);div.classList.remove('sel');}else{dateList[date].add(t);div.classList.add('sel');}};grid.appendChild(div);});}
document.getElementById('sendBtn').onclick=()=>{data.slots=[];Object.entries(dateList).forEach(([d,set])=>set.forEach(t=>data.slots.push(`${d} ${t}`)));data.slots.sort();localStorage.setItem('event_'+eventId,JSON.stringify(data));const url=location.origin+location.pathname.replace('organizer.html','participant.html')+'?event='+eventId;const info=document.getElementById('shareInfo');info.textContent='å‚åŠ è€…ç”¨ URL: '+url;info.classList.remove('hidden');alert('å€™è£œæ—¥æ™‚ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚å‚åŠ è€…ã« URL ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚');document.querySelector('.tabbtn[data-tab="status"]').click();};

  
  /* ===== â…¡ å‚åŠ çŠ¶æ³ ===== */
function renderStatus(){
  /* â˜… infoBox ã®å†…å®¹ã‚’æ›´æ–°ã™ã‚‹ ---------------- */
  const info = document.getElementById('infoBox');
  if (info) {
    // é–‹å‚¬è€…URL = ä»Šè¡¨ç¤ºã—ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸
    const organizerUrl =
      location.origin + location.pathname + '?event=' + eventId + '&tab=status';
    // å‚åŠ è€…URL
    const participantUrl =
      location.origin +
      location.pathname.replace('organizer.html', 'participant.html') +
      '?event=' + eventId;

    // å€™è£œæ—¥ç¨‹ã‚’ "YYYY-MM-DD HH:MM" å½¢å¼ã§ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šè¡¨ç¤º
    // â€»ã“ã“ã‹ã‚‰ â–¼ å·®ã—æ›¿ãˆ â–¼
let slotsHtml;
if (data.slots && data.slots.length) {
  // { "YYYY-MM-DD": ["HH:MM", ...] } ã¸ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
  const grouped = {};
  data.slots.forEach(s => {
    const [d, t] = s.split(' ');
    (grouped[d] ??= []).push(t);
  });

  // HTML ãƒ†ãƒ¼ãƒ–ãƒ«åŒ–ï¼ˆå¹´ã¯è½ã¨ã—ã€æ—¥ä»˜æ˜‡é †ï¼‰
  slotsHtml = '<table style="border-collapse:collapse;font-size:13px;">' +
    Object.entries(grouped)
      .sort(([a], [b]) => a.localeCompare(b))
      .map(([d, arr]) => {
        const mmdd = d.slice(5); // "YYYY-MM-DD" â†’ "MM-DD"
        const cells = arr.map(t => `<td style="border:1px solid #ccc;padding:2px 6px;">${t}</td>`).join('');
        return `<tr><td style="border:1px solid #ccc;padding:2px 6px;font-weight:bold;">${mmdd}</td>${cells}</tr>`;
      })
      .join('') +
    '</table>';
} else {
  slotsHtml = 'ï¼ˆã¾ã å€™è£œãŒã‚ã‚Šã¾ã›ã‚“ï¼‰';
}
// â–² å·®ã—æ›¿ãˆã“ã“ã¾ã§


    info.innerHTML =
      `<strong>é–‹å‚¬è€…URL:</strong> <a href="${organizerUrl}" target="_blank">${organizerUrl}</a><br>` +
      `<strong>å‚åŠ è€…URL:</strong> <a href="${participantUrl}" target="_blank">${participantUrl}</a><br>` +
      `<strong>å€™è£œæ—¥ç¨‹:</strong> ${slotsHtml}`;
  }
  const wrap=document.getElementById('listTab');wrap.innerHTML='';
  if(data.slots.length===0){wrap.textContent='å€™è£œãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';return;}
  const grouped={};data.slots.forEach(s=>{const [d]=s.split(' ');(grouped[d]??=[]).push(s);});
  Object.keys(grouped).sort().forEach(date=>{
    const h3=document.createElement('h3');h3.textContent=date;wrap.appendChild(h3);
    const tbl=document.createElement('table');
    const thRow=document.createElement('tr');thRow.appendChild(document.createElement('th')).textContent='å‚åŠ è€… / æ™‚é–“';
    grouped[date].forEach(s=>{const th=document.createElement('th');th.textContent=s.split(' ')[1];thRow.appendChild(th);});tbl.appendChild(thRow);
    const tbody = document.createElement('tbody');
tbody.id = 'participantRows_' + date;
tbl.appendChild(tbody);

data.participants.forEach(p => {
  const tr = document.createElement('tr');
  tr.dataset.name = p.name;

  const nameCell = document.createElement('td');
  const delBtn = document.createElement('button');
  delBtn.textContent = 'ğŸ—‘';
  delBtn.className = 'del';
  delBtn.title = 'ã“ã®å‚åŠ è€…ã‚’å‰Šé™¤';
  delBtn.onclick = () => deleteParticipant(p.name);
  nameCell.append(p.name, ' ', delBtn);
  nameCell.style.cursor = 'pointer';
  nameCell.onclick = () => toggleHighlight(p.name);
  tr.appendChild(nameCell);

  grouped[date].forEach(s => {
    const td = document.createElement('td');
    const mark = p.avail[s] || '';
    td.textContent = mark;
    if (mark === 'â—‹') {
      td.classList.add('clickable');
      if (isMatched(s, p.name)) td.classList.add('match');
      td.onclick = () => toggleMatch(s, p.name, td);
    }
    tr.appendChild(td);
  });

  tbody.appendChild(tr);
});

Sortable.create(tbody, {
  animation: 150,
  onEnd: () => {
    const rows = [...tbody.querySelectorAll('tr')];
    const names = rows.map(r => r.dataset.name);
    data.participants.sort((a, b) => names.indexOf(a.name) - names.indexOf(b.name));
    localStorage.setItem('event_' + eventId, JSON.stringify(data));
    renderResult();
  }
});

    const sumRow=document.createElement('tr');sumRow.appendChild(document.createElement('td')).textContent='åˆè¨ˆç‚¹';
    grouped[date].forEach(s=>{const total=data.participants.reduce((a,p)=>a+(p.avail[s]==='â—‹'?1:0),0);sumRow.appendChild(document.createElement('td')).textContent=total;});
    tbl.appendChild(sumRow);wrap.appendChild(tbl);
  });
}

function toggleHighlight(name){document.querySelectorAll(`#listTab tr[data-name="${name}"]`).forEach(r=>r.classList.toggle('hl'));}
function isMatched(slot,name){return data.matches.some(m=>m.slot===slot&&m.name===name);}
function toggleMatch(slot,name,cell){if(isMatched(slot,name)){data.matches=data.matches.filter(m=>!(m.slot===slot&&m.name===name));cell.classList.remove('match');}else{data.matches.push({slot,name});cell.classList.add('match');}localStorage.setItem('event_'+eventId,JSON.stringify(data));}

/* â˜… å‚åŠ è€…å‰Šé™¤å‡¦ç† */
function deleteParticipant(name){
  if(!confirm(`${name} ã•ã‚“ã®å›ç­”ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  data.participants=data.participants.filter(p=>p.name!==name);
  data.matches=data.matches.filter(m=>m.name!==name);
  localStorage.setItem('event_'+eventId,JSON.stringify(data));
  renderStatus();renderResult();
}

/* ===== â…¢ èª¿æ•´çµæœ ===== */
function renderResult(){
  const div=document.getElementById('matchWrap');div.innerHTML='';
  if(data.matches.length===0){div.textContent='ã¾ã ãƒãƒƒãƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‚åŠ çŠ¶æ³ã‚¿ãƒ–ã§â—‹ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚';return;}
  const grouped={};data.matches.forEach(m=>(grouped[m.slot]??=[]).push(m.name));
  Object.keys(grouped).sort().forEach(slot=>{const h3=document.createElement('h3');h3.textContent=slot;div.appendChild(h3);const ul=document.createElement('ul');grouped[slot].forEach(n=>{const li=document.createElement('li');li.textContent=n;ul.appendChild(li);});div.appendChild(ul);});
}

// ğŸ”„ æ›´æ–°ãƒœã‚¿ãƒ³ã®å‡¦ç†
document.getElementById('refreshBtn').onclick = () => {
  const snap = localStorage.getItem('event_' + eventId);
  if (snap) {
    data = JSON.parse(snap);
    renderStatus();      // å‚åŠ çŠ¶æ³ã‚’å†æç”»
    renderResult();      // èª¿æ•´çµæœã‚‚å†æç”»
  } else {
    alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
  }
};
  
/* ===== CSV ===== */
document.getElementById('csvBtn').onclick=()=>{let csv='å‚åŠ è€…,'+data.slots.join(',')+'\n';data.participants.forEach(p=>csv+=p.name+','+data.slots.map(s=>p.avail[s]||'').join(',')+'\n');csv+='åˆè¨ˆç‚¹,'+data.slots.map(s=>data.participants.reduce((a,p)=>a+(p.avail[s]==='â—‹'?1:0),0)).join(',')+'\n';const blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='schedule_'+eventId+'.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);};
</script>
</body>
</html>
